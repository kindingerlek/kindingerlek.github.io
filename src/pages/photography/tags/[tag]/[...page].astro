---
export const prerender = true

import type { GetStaticPaths } from 'astro'
import PhotoCollection from '@/collections/photos'
import PhotographyLayout from '@/layouts/PhotographyLayout.astro'

export const getStaticPaths = (async ({ paginate }) => {
	const allPhotos = await PhotoCollection.getAll()
	const allPhotosByDate = await PhotoCollection.sortedByDate(allPhotos)

	// Get unique tags and count their occurrences
	const uniqueTags = await PhotoCollection.getUniqueTags(allPhotos)

	const tagCounts = uniqueTags.map((tag) => {
		const count = allPhotos.filter(
			(project) => project.data.tags && project.data.tags.includes(tag)
		).length
		return { tag, count }
	})

	// Sort tags by count in descending order
	const sortedTags = tagCounts
		.sort((a, b) => b.count - a.count)
		.map((item) => item.tag)
		.slice(0, 15)

	return sortedTags.flatMap((tag) =>
		paginate(allPhotosByDate, {
			pageSize: 24,
			props: { uniqueTags: sortedTags },
			params: { tag, page: '1' }
		})
	)
}) satisfies GetStaticPaths

const { page, uniqueTags } = Astro.props
const currentTag = Astro.params.tag
---

<PhotographyLayout page={page} uniqueTags={uniqueTags} currentTag={currentTag} />
